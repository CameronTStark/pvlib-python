# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
  branches:
    include:
    - azure_cd
    - refs/tags/{tagname}

stages:
- stage: Test
  jobs:
  - job: test_linux
  - template: ci/azure/conda_linux.yml
    parameters:
      name: Test_conda_linux
      vmImage: ubuntu-16.04

  condition: contains(variables['Build.SourceBranch'], 'tags')
  jobs:
  - job: 'Publish'
    dependsOn: 'Test_conda_linux'
    variables:
      API_KEY: $(TEST_PYPI_API_KEY)
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
        architecture: 'x64'

    - script: python setup.py sdist bdist_wheel
      displayName: 'Build sdist and wheel'

    - script: pip install wheel twine
      displayName: 'Install distribution dependencies'

    - script: |
        python -m twine upload --repository-url "https://test.pypi.org/legacy/" --username "__token__" --password $(API_KEY) dist/*
      displayName: 'Upload to PyPI'
